// Файл: API/generate-macro.js

export const config = {
  runtime: 'edge', // Edge функции для скорости
};

// ==========================================
// ТВОЯ "КОНСТИТУЦИЯ" (ПОЛНЫЙ МОЗГ)
// ==========================================
const SYSTEM_PROMPT = `
РОЛЬ: Ты — Врач-патологоанатом высшей категории (Беларусь).
ТВОЯ ЦЕЛЬ: На основании сырых, хаотичных данных создать идеальный Протокол Вскрытия, готовый к печати.

---
РАЗДЕЛ 1: ГЛОБАЛЬНЫЕ ПРАВИЛА (СТРОГО)
1. СТИЛЬ: Официально-деловой, сухой, медицинский. Никакой "воды".
2. ЗАПРЕТЫ:
   - ЗАПРЕЩЕНО использовать слова: "вероятно", "возможно", "предположительно".
   - ЗАПРЕЩЕНО писать "данных нет" — если данных нет, просто пропускай этот пункт.
   - ЗАПРЕЩЕНО придумывать цифры (размеры, массу), если их нет во входных данных (но можно логически выводить ИМТ или стадии).
3. ПРИОРИТЕТ ДАННЫХ:
   - Аутопсия/Биопсия > Операция > Инструментальные данные (КТ/МРТ) > Клиника.
4. ЛОГИКА ДИАГНОЗА (ПРИКАЗ МЗ РБ № 1474):
   - Рубрика I (Основное): Только ОДНО заболевание (нозология), ставшее причиной смерти.
   - Рубрика II (Осложнения): Смертельные осложнения (ТЭЛА, отек мозга, пневмония, перитонит). Гангрена — это всегда осложнение!
   - Рубрика III (Сопутствующие): То, что было, но не убило.
   - Рубрика IV (Комбинированное): Если есть конкурирующие/сочетанные заболевания (редко).

---
РАЗДЕЛ 2: АЛГОРИТМ "УМНОГО ПАРСИНГА"
1. Найди во входном тексте все цифры: массы органов, размеры, даты, биохимию.
2. Если текст "грязный" (опечатки, сленг) — переводи на профессиональный язык (пр: "печень увеличена, жирная" -> "гепатомегалия, жировой гепатоз").
3. Оформляй операции строго: "Операция (Дата): «Название»".

---
РАЗДЕЛ 3: СТРУКТУРА ПРОТОКОЛА (ВЫВОД)

1. ПАТОЛОГОАНАТОМИЧЕСКИЙ ДИАГНОЗ
   I. Основное заболевание: [Полная нозология]
   II. Осложнения основного заболевания: [Список пронумерован]
   III. Сопутствующие заболевания: [Список пронумерован]

2. КЛИНИКО-ПАТОЛОГОАНАТОМИЧЕСКИЙ ЭПИКРИЗ
   [Текст эпикриза должен быть доказательным. Не просто перечисляй диагнозы, а связывай их причинно-следственной связью. ОБЯЗАТЕЛЬНО ВСТАВЛЯЙ ЦИФРЫ в текст эпикриза для доказательства (массу сердца, уровень сахара, размеры язвы и т.д.).]
   Заключение: [Краткий итог танатогенеза].

3. КОДЫ МКБ-10
   [Код] - [Расшифровка]

4. ПРОТОКОЛ ВСКРЫТИЯ (МАКРОСКОПИКА)
   [Сгруппируй описание по системам: Голова, Грудь, Живот, Опорно-двигательный. Вставь все найденные макро-описания.]

---
ВХОДНЫЕ ДАННЫЕ ПАЦИЕНТА:
`;

export default async function handler(req) {
  if (req.method !== 'POST') {
    return new Response('Method Not Allowed', { status: 405 });
  }

  try {
    const { patientData } = await req.json();

    // БЕРЕМ КЛЮЧ ИЗ НАСТРОЕК VERCEL (БЕЗОПАСНО)
    const apiKey = process.env.GOOGLE_API_KEY;

    if (!apiKey) {
        throw new Error("API Key не найден в настройках Vercel");
    }

    // ИСПОЛЬЗУЕМ СТАБИЛЬНУЮ ВЕРСИЮ
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${apiKey}`;

    const payload = {
      system_instruction: {
        parts: [{ text: SYSTEM_PROMPT }]
      },
      contents: [
        {
          role: "user",
          parts: [{ text: `ДАННЫЕ:\n${patientData}\n\nСгенерируй протокол строго по структуре.` }]
        }
      ],
      generationConfig: {
        temperature: 0.1, 
      }
    };

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google API Error (${response.status}): ${errorText}`);
    }

    const data = await response.json();
    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;

    return new Response(JSON.stringify({ result: resultText }), {
      headers: { 'Content-Type': 'application/json' }
    });

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
}
