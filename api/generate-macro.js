// –§–∞–π–ª: API/generate-macro.js

export const config = {
  runtime: 'edge', // –ò—Å–ø–æ–ª—å–∑—É–µ–º Edge –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
};

// --- –¢–í–û–ô –ü–û–õ–ù–´–ô –ü–†–û–ú–¢ ---
const SYSTEM_PROMPT = `
–¢–´ ‚Äî –í–†–ê–ß-–ü–ê–¢–û–õ–û–ì–û–ê–ù–ê–¢–û–ú –í–´–°–®–ï–ô –ö–ê–¢–ï–ì–û–†–ò–ò.
–¢–í–û–Ø –ó–ê–î–ê–ß–ê ‚Äî –ü–†–ï–í–†–ê–¢–ò–¢–¨ –°–´–†–û–ô –ú–ê–°–°–ò–í –î–ê–ù–ù–´–• –í –ü–û–õ–ù–´–ô –ü–†–û–¢–û–ö–û–õ.

–†–ê–ó–î–ï–õ I: –†–û–õ–¨ –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê

–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê (–ö–û–ù–°–¢–ò–¢–£–¶–ò–Ø):
0. –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö –î–ê–ù–ù–´–• (SMART PARSING):
‚Ä¢	–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ö–∞–æ—Ç–∏—á–Ω—ã–º. –ù–∞–π–¥–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–º–∞—Å—Å—ã –æ—Ä–≥–∞–Ω–æ–≤, —Ä–∞–∑–º–µ—Ä—ã, –±–∏–æ—Ö–∏–º–∏—é) –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è.
1. –ü–†–ò–û–†–ò–¢–ï–¢ –î–ê–ù–ù–´–•:
–ü—Ä–∏–∂–∏–∑–Ω–µ–Ω–Ω–∞—è –±–∏–æ–ø—Å–∏—è / –û–ø–µ—Ä–∞—Ü–∏—è / –ê—É—Ç–æ–ø—Å–∏—è > –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ > –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è > –ö–ª–∏–Ω–∏–∫–∞.
2. –†–ê–ë–û–¢–ê –° –¶–ò–§–†–ê–ú–ò:
‚Ä¢	–í –ú–ê–ö–†–û–û–ü–ò–°–ê–ù–ò–ò: –£–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã (—Å–º), –º–∞—Å—Å—É (–≥), –æ–±—ä–µ–º (–º–ª).
‚Ä¢	–í –î–ò–ê–ì–ù–û–ó–ï: –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å –º–∞—Å—Å—É –æ—Ä–≥–∞–Ω–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä—ã (–∫—Ä–æ–º–µ % —Å—Ç–µ–Ω–æ–∑–∞ –∏ –¥–∞—Ç).
‚Ä¢	–í –≠–ü–ò–ö–†–ò–ó–ï: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –¥–ª—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞.
3. –°–¢–†–û–ì–ò–ô –§–û–†–ú–ê–¢ –û–ü–ï–†–ê–¶–ò–ô:
"–û–ø–µ—Ä–∞—Ü–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì): ¬´[–ù–∞–∑–≤–∞–Ω–∏–µ]¬ª".
4. –ó–ê–ü–†–ï–©–ï–ù–ù–´–ï –§–û–†–ú–£–õ–ò–†–û–í–ö–ò:
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ "–≤–µ—Ä–æ—è—Ç–Ω–æ", "–≤–æ–∑–º–æ–∂–Ω–æ". –ù–µ –ø–∏—à–∏ "–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç" ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–π –±–ª–æ–∫.
5. –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ü–†–ò–ö–ê–ó–£ –ú–ó –†–ë ‚Ññ 1474:
‚Ä¢	–°–æ–±–ª—é–¥–∞–π –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–∏.
‚Ä¢	–ì–∞–Ω–≥—Ä–µ–Ω–∞ –∫–∏—à–µ—á–Ω–∏–∫–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏–µ.

–†–ê–ó–î–ï–õ II: –ê–õ–ì–û–†–ò–¢–ú –†–ê–ë–û–¢–´
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ä–≥–∞–Ω–∞/—Å–∏—Å—Ç–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω –æ–ø–∏—Å–∞–Ω–∏—è (–ú–∞–∫—Ä–æ, –ú–∏–∫—Ä–æ).
3. –°—Ñ–æ—Ä–º–∏—Ä—É–π –î–∏–∞–≥–Ω–æ–∑ (–†—É–±—Ä–∏–∫–∏ I, II, III, IV) –≤—ã–±—Ä–∞–≤ –û–î–ù–û –æ—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ.
4. –°—Ñ–æ—Ä–º–∏—Ä—É–π –≠–ø–∏–∫—Ä–∏–∑, –æ–±–æ—Å–Ω–æ–≤–∞–≤ —Ç–∞–Ω–∞—Ç–æ–≥–µ–Ω–µ–∑ —Ü–∏—Ñ—Ä–∞–º–∏.

–°–¢–†–£–ö–¢–£–†–ê –í–´–í–û–î–ê (–°–¢–†–û–ì–û):
1. –ü–†–û–¢–û–ö–û–õ –í–°–ö–†–´–¢–ò–Ø (–ú–∞–∫—Ä–æ –∏ –ú–∏–∫—Ä–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ —Å–∏—Å—Ç–µ–º–∞–º: –ì–æ–ª–æ–≤–∞, –ì—Ä—É–¥—å, –ñ–∏–≤–æ—Ç, –û—Ä–≥–∞–Ω—ã).
2. –ü–ê–¢–û–õ–û–ì–û–ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ô –î–ò–ê–ì–ù–û–ó (–†—É–±—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π).
3. –ö–õ–ò–ù–ò–ö–û-–ü–ê–¢–û–õ–û–ì–û–ê–ù–ê–¢–û–ú–ò–ß–ï–°–ö–ò–ô –≠–ü–ò–ö–†–ò–ó.
4. –ö–û–î–´ –ú–ö–ë-10 (–ß–∞—Å—Ç—å I –∏ II).
`;

// --- –ö–û–î –°–ï–†–í–ï–†–ê (–≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø) ---

export default async function handler(req) {
  if (req.method !== 'POST') {
    return new Response('Method Not Allowed', { status: 405 });
  }

  try {
    const { patientData } = await req.json();
    const apiKey = process.env.GOOGLE_API_KEY;

    if (!apiKey) {
      return new Response(JSON.stringify({ error: '–ö–ª—é—á API –Ω–µ –Ω–∞–π–¥–µ–Ω' }), { status: 500 });
    }

    // –ü–†–û–ë–£–ï–ú –í–ï–†–°–ò–Æ GEMINI 3 FLASH, –ö–ê–ö –¢–´ –ü–†–û–°–ò–õ
    // –ï—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è —Ç–≤–æ–µ–≥–æ –∫–ª—é—á–∞ ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–∫–µ—Ç–∞! üöÄ
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash:generateContent?key=${apiKey}`;

    const payload = {
      system_instruction: {
        parts: [{ text: SYSTEM_PROMPT }]
      },
      contents: [
        {
          role: "user",
          parts: [{ text: `–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:\n${patientData}\n\n–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª.` }]
        }
      ],
      generationConfig: {
        temperature: 0.2,
      }
    };

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Google API Error (${response.status}): ${errorText}`);
    }

    const data = await response.json();
    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!resultText) {
      throw new Error('–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.');
    }

    return new Response(JSON.stringify({ result: resultText }), {
      headers: { 'Content-Type': 'application/json' }
    });

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
}
